# Investigation Plan: Supabase Password Reset Failures

## 1. Objective

To diagnose and resolve the root cause of the "One-time token not found" error that occurs during the Supabase password reset flow, resulting in users being unable to reset their passwords.

## 2. Current Status & Key Finding

- **Symptom:** Users requesting a password reset receive a link that immediately fails, showing an "Email link is invalid or has expired" error on the application's UI.
- **Root Cause Indication:** Supabase authentication logs confirm the underlying backend error is **"One-time token not found"**. This means the PKCE token in the email link is not found in Supabase's database when the verification attempt is made.
- **Verified Steps:** We have already corrected the application code (`/auth/confirm`), Supabase email templates (`{{ .ConfirmationURL }}`), and whitelisted the redirect URL (`.../auth/confirm`). The issue is not with our application's error handling but with Supabase's token validation process.

## 3. Working Hypothesis

The `pkce_` token generated by `resetPasswordForEmail()` is being invalidated or is not being persisted correctly by Supabase for this project. This could be due to a specific configuration setting or an issue within the Supabase service itself. The blank `{{ .TokenLifeSpan }}` variable in the sent email supports this hypothesis, suggesting the token is created with a zero or null lifespan.

## 4. Information We Need to Gather (Diagnostics)

To proceed, we need to gather the following critical pieces of diagnostic information.

### 4.1. Supabase JWT Expiry Configuration

While most settings were not visible in the dashboard, the default JWT expiry is a critical piece of configuration.
- **Action Required:** In your Supabase project, go to **SQL Editor** -> **New query**. Run the following query to check the configured JWT expiry time (in seconds). The default is 3600 (1 hour).
  ```sql
  select * from auth.get_jwt_expiry();
  ```
- **Information to provide:** The result of this SQL query.

### 4.2. Network Redirect Chain Analysis

We need to see the exact sequence of network requests and redirects that happen when you click the email link. This will show us the headers and status codes at each step, which is the ground truth of the flow.
- **Action Required:**
  1.  Open your browser (e.g., Chrome, Firefox).
  2.  Open the **Developer Tools** (F12 or Ctrl+Shift+I) and go to the **Network** tab.
  3.  In the Network tab, make sure the **"Preserve log"** checkbox is **ticked**. This is very important as it will show the full redirect chain.
  4.  Request a new password reset email.
  5.  With the Network tab still open, click the link in the new email.
  6.  You will see several lines appear in the Network tab. Please take a **screenshot of the entire list of network requests** that were made, from the initial `verify?token=pkce_...` request to the final `/auth/confirm` request. We need to see the "Status" and "Type" columns for each request.

### 4.3. Test User State

We need to check the state of the test user in the Supabase database.
- **Action Required:**
  1.  In your Supabase project, go to **Authentication** -> **Users**.
  2.  Find the test user you are using for this flow.
  3.  Click on the user to view their details.
  4.  Please provide the value for **"Last Sign In"** and **"Email Confirmed"**. This can help determine if any partial session is being created.

## 5. Next Steps (Post-Investigation)

We will **not** make any further code changes until we have analyzed the information from the three points above. Based on the findings, the next steps will be determined. For example:
- If the JWT expiry is 0, we have found the configuration issue.
- If the network log shows an unexpected redirect or error code from the `/verify` endpoint, it will confirm the issue is with the Supabase backend.
- If the user state shows something unusual, it may point to a different area of investigation.

By gathering this information methodically, we can provide a complete and accurate report to a senior developer or Supabase support if necessary. 