# MixerAI 2.0 - UI and Authentication Updates

## Changes Made

### 1. Dashboard UI Update
- Removed the Analytics tab from the root dashboard page
- Simplified the tab interface to only include the Overview tab
- Changed the TabsList grid from grid-cols-2 to grid-cols-1

### 2. User Authentication Integration
- Updated the users API route to connect directly to Supabase authentication data
- Added integration with Supabase Auth Admin API to fetch real user data
- Merged authentication user data with profile information from the profiles table
- Enhanced the user data structure to include:
  - User metadata from Supabase Auth
  - Last sign-in timestamp
  - Role information from user_brand_permissions
  - Fallback avatar generation for users without profile images

## Implementation Details

### API Route Update
The `/api/users` route now:
1. Fetches all users from Supabase Auth Admin API
2. Retrieves associated profile data from the profiles table
3. Merges the data to provide complete user information
4. Determines the highest role for each user based on permissions

### User Data Structure
```typescript
{
  id: string,
  full_name: string,
  email: string,
  avatar_url: string,
  role: string,
  created_at: string,
  last_sign_in_at: string,
  brand_permissions: Array<{
    id: string,
    brand_id: string,
    role: 'admin' | 'editor' | 'viewer'
  }>
}
```

### Routing Structure Issues Fix
- Fixed route conflicts between the `/dashboard/*` routes and the `/(dashboard)/*` route group
- Implemented proper redirects to maintain backward compatibility 

## Benefits
- Live authentication data is now visible in the Users interface
- Simplified dashboard UI focuses on the most important content
- More complete user information for better user management
- Consistent user experience between local and production environments
- Fixed routing structure prevents duplicate layouts and navigation elements

## Requirements
- Requires SUPABASE_SERVICE_ROLE_KEY to be set in environment variables
- Needs the auth.admin.listUsers permission for the service role

# MixerAI 2.0 Documentation

## Azure OpenAI Integration

The application integrates with Azure OpenAI to generate brand identity content and other marketing materials. The integration has been improved with the following enhancements:

### Fixed Azure OpenAI Client Configuration

- Properly formats the Azure OpenAI endpoint URL to ensure it doesn't have trailing slashes
- Uses the correct `model` parameter (not `deployment_id`) for API calls
- Correctly constructs the API path for Azure OpenAI using the deployment name
- Enhanced error handling with specific error messages for common issues

### Testing and Diagnostics

- Enhanced `/api/test-openai` endpoint for diagnosing Azure OpenAI connection issues
- Improved error messages that provide specific troubleshooting guidance
- Added detailed logging for Azure OpenAI API calls

### Error Handling Improvements

- Removed fallback generation to prevent using incorrect AI-generated content
- Added specific error messages for different types of API failures
- Created a troubleshooting guide at `docs/AZURE_OPENAI_TROUBLESHOOTING.md`

### User Interface Enhancements

- Brand creation and edit pages now display meaningful error messages
- Added confirmation before overwriting existing brand identity data
- Improved country-specific vetting agencies selection with checkboxes

## Environment Configuration

The application requires the following environment variables for Azure OpenAI:

```
AZURE_OPENAI_API_KEY=your_api_key
AZURE_OPENAI_ENDPOINT=https://your-resource-name.openai.azure.com
AZURE_OPENAI_DEPLOYMENT=your_deployment_name
```

All three variables must be set for the AI features to work properly. A diagnostic endpoint is available at `/api/test-openai` to verify your configuration.

## Brand Management

The brand management features include:

- Create and edit brands with basic information
- Generate comprehensive brand identity using AI from website URLs
- Country-specific content vetting agencies suggestions
- Tabbed interface separating basic details from AI-generated content

## Content Vetting Agencies

Content vetting agencies are displayed as a selectable list of checkboxes under the "Suggested Agencies for [Country]" section. When a brand identity is generated via AI, the system will suggest 10 relevant vetting agencies specific to the brand's country, industry, and content needs. These agencies are dynamically generated by the AI based on its analysis of the brand's website content and the selected country.

Users can select from these AI-generated suggested agencies to comply with relevant content regulations. The selected agencies are stored as a comma-separated list in the `content_vetting_agencies` field in the database.

## Brand Color Generation

The system now uses AI to analyze a brand's website and automatically generate an appropriate color that reflects the brand's visual identity. This color is:

- Generated when creating a new brand or regenerating brand identity information
- Stored as a HEX color code in the `brand_color` field in the database
- Used visually in the UI to identify the brand
- Editable via a color picker by the user if they wish to change it
- Customized specifically for each brand based on AI analysis of their website colors and design elements

The brand color enhances visual recognition and consistency throughout the application, making it easier for users to quickly identify and work with different brands.

## User Interface Components

### Brand Visualization Components

#### BrandIcon Component

A consistent way to display brand avatars throughout the application using the brand's color:

```typescript
// src/components/brand-icon.tsx
export function BrandIcon({ 
  name, 
  color = "#3498db", 
  size = "md", 
  className 
}: BrandIconProps) {
  // Implementation details
}
```

- **Features**:
  - Displays the first letter of the brand name in a circular avatar
  - Uses the brand's color for text and background (with opacity)
  - Supports different sizes (sm, md, lg)
  - Fully customizable through className prop
  - Falls back to default blue (#3498db) if no color is provided

- **Usage Examples**:
  - Brand cards in dashboard and brand listing
  - Brand selection dropdowns
  - Content listing where brand is displayed
  - Anywhere a brand needs visual identification

This component enhances visual recognition and consistency throughout the application, making it easier for users to quickly identify and work with different brands.

## Future Improvements

Potential future improvements include:

- Implementing retry logic for transient Azure OpenAI API errors
- Adding more detailed validation for environment variables at startup
- Enhancing the AI-generated content with additional examples and references 

## Workflow User Assignment

The MixerAI 2.0 application now supports assigning users to workflow stages during the workflow creation and editing process.

### Key Features

- **User Assignment by Email**: Users can be assigned to workflow stages by email addresses
- **Existing Users Recognition**: If an email belongs to an existing user, they are automatically assigned
- **User Invitation**: If an email doesn't match an existing user, an invitation is created
- **Role-Based Access**: Each workflow stage has an associated role (editor, admin, etc.)
- **Multiple Assignees**: Each workflow stage can have multiple assignees

### Technical Implementation

#### Database Schema

The workflow schema uses a JSONB column to store steps with assignees:

```json
{
  "steps": [
    {
      "id": 1,
      "name": "Draft Review",
      "description": "Initial review by the content author",
      "role": "editor",
      "approvalRequired": true,
      "assignees": [
        {"email": "user1@example.com", "id": "user-uuid-if-exists"},
        {"email": "user2@example.com", "id": "user-uuid-if-exists"}
      ]
    }
  ]
}
```

A separate `workflow_invitations` table tracks invitations for users not yet in the system:

```sql
CREATE TABLE workflow_invitations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workflow_id UUID REFERENCES workflows(id) ON DELETE CASCADE,
  step_id INTEGER NOT NULL,
  email TEXT NOT NULL,
  role TEXT NOT NULL,
  invite_token TEXT NOT NULL UNIQUE,
  status TEXT DEFAULT 'pending', -- 'pending', 'accepted', 'declined'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  UNIQUE(workflow_id, step_id, email)
);
```

#### User Interface

The workflow creation and editing pages include:

- Input field for entering assignee emails
- List of current assignees with removal option
- Email validation to ensure correct format
- Prevention of duplicate email assignments

#### API Implementation

The API handles:
1. Checking if an assignee email belongs to an existing user
2. Creating invitations for new users
3. Tracking assignee status in the workflow steps
4. Managing invitation lifecycle (pending, accepted, declined)

### Usage

1. Create or edit a workflow
2. Add steps as needed
3. For each step, enter email addresses to assign users
4. Save the workflow
5. Users will either:
   - See their assignments directly (if already in the system)
   - Receive an invitation email (if not yet a user)

### Future Enhancements

- Email notification system integration
- User invitation acceptance flow
- Assignment history tracking
- Reassignment capabilities 