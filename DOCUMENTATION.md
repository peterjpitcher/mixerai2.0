# MixerAI 2.0 - UI and Authentication Updates

## Changes Made

### 1. Dashboard UI Update
- Removed the Analytics tab from the root dashboard page
- Simplified the tab interface to only include the Overview tab
- Changed the TabsList grid from grid-cols-2 to grid-cols-1

### 2. User Authentication Integration
- Updated the users API route to connect directly to Supabase authentication data
- Added integration with Supabase Auth Admin API to fetch real user data
- Merged authentication user data with profile information from the profiles table
- Enhanced the user data structure to include:
  - User metadata from Supabase Auth
  - Last sign-in timestamp
  - Role information from user_brand_permissions
  - Fallback avatar generation for users without profile images

## Implementation Details

### API Route Update
The `/api/users` route now:
1. Fetches all users from Supabase Auth Admin API
2. Retrieves associated profile data from the profiles table
3. Merges the data to provide complete user information
4. Determines the highest role for each user based on permissions

### User Data Structure
```typescript
{
  id: string,
  full_name: string,
  email: string,
  avatar_url: string,
  role: string,
  created_at: string,
  last_sign_in_at: string,
  brand_permissions: Array<{
    id: string,
    brand_id: string,
    role: 'admin' | 'editor' | 'viewer'
  }>
}
```

### Routing Structure Issues Fix
- Fixed route conflicts between the `/dashboard/*` routes and the `/(dashboard)/*` route group
- Implemented proper redirects to maintain backward compatibility 

## Benefits
- Live authentication data is now visible in the Users interface
- Simplified dashboard UI focuses on the most important content
- More complete user information for better user management
- Consistent user experience between local and production environments
- Fixed routing structure prevents duplicate layouts and navigation elements

## Requirements
- Requires SUPABASE_SERVICE_ROLE_KEY to be set in environment variables
- Needs the auth.admin.listUsers permission for the service role

# MixerAI 2.0 Documentation

## Azure OpenAI Integration

The MixerAI 2.0 application uses Azure OpenAI to generate brand identities, content, and other AI-powered features. The integration is managed through the `src/lib/azure/openai.ts` module.

### Required Environment Variables

For Azure OpenAI integration to work correctly, you need to set up the following environment variables:

```
AZURE_OPENAI_API_KEY=your_api_key
AZURE_OPENAI_ENDPOINT=https://your-resource-name.openai.azure.com
AZURE_OPENAI_DEPLOYMENT=your_deployment_name
```

### Debugging and Troubleshooting

If you encounter issues with the Azure OpenAI integration, you can use the following tools and resources:

1. **Test Script**: Run `node scripts/test-azure-openai.js` to test your Azure OpenAI credentials directly.
2. **Test API Endpoint**: Visit `http://localhost:3001/api/test-azure-openai` to test the integration through the API.
3. **Documentation**: 
   - `docs/AZURE_OPENAI_TROUBLESHOOTING.md` - Detailed troubleshooting guide
   - `docs/AUTO_GENERATE_DESCRIPTION_FIX.md` - Fix for the brand identity generation issue

### Fallback Content Generation

When Azure OpenAI is not available or when an error occurs during API calls, the system falls back to using predefined templates based on industry detection from URLs. This ensures that the application can continue functioning even in the absence of a working AI connection.

## Brand Management

The brand management features include:

- Create and edit brands with basic information
- Generate comprehensive brand identity using AI from website URLs
- Country-specific content vetting agencies suggestions
- Tabbed interface separating basic details from AI-generated content

## Content Vetting Agencies

Content vetting agencies are displayed as a selectable list of checkboxes under the "Suggested Agencies for [Country]" section. When a brand identity is generated via AI, the system will suggest 10 relevant vetting agencies specific to the brand's country, industry, and content needs. These agencies are dynamically generated by the AI based on its analysis of the brand's website content and the selected country.

Users can select from these AI-generated suggested agencies to comply with relevant content regulations. The selected agencies are stored as a comma-separated list in the `content_vetting_agencies` field in the database.

## Brand Color Generation

The system now uses AI to analyze a brand's website and automatically generate an appropriate color that reflects the brand's visual identity. This color is:

- Generated when creating a new brand or regenerating brand identity information
- Stored as a HEX color code in the `brand_color` field in the database
- Used visually in the UI to identify the brand
- Editable via a color picker by the user if they wish to change it
- Customized specifically for each brand based on AI analysis of their website colors and design elements

The brand color enhances visual recognition and consistency throughout the application, making it easier for users to quickly identify and work with different brands.

## User Interface Components

### Brand Visualization Components

#### BrandIcon Component

A consistent way to display brand avatars throughout the application using the brand's color:

```typescript
// src/components/brand-icon.tsx
export function BrandIcon({ 
  name, 
  color = "#3498db", 
  size = "md", 
  className 
}: BrandIconProps) {
  // Implementation details
}
```

- **Features**:
  - Displays the first letter of the brand name in a circular avatar
  - Uses the brand's color for text and background (with opacity)
  - Supports different sizes (sm, md, lg)
  - Fully customizable through className prop
  - Falls back to default blue (#3498db) if no color is provided

- **Usage Examples**:
  - Brand cards in dashboard and brand listing
  - Brand selection dropdowns
  - Content listing where brand is displayed
  - Anywhere a brand needs visual identification

This component enhances visual recognition and consistency throughout the application, making it easier for users to quickly identify and work with different brands.

## Future Improvements

Potential future improvements include:

- Implementing retry logic for transient Azure OpenAI API errors
- Adding more detailed validation for environment variables at startup
- Enhancing the AI-generated content with additional examples and references 

## Workflow User Assignment

The MixerAI 2.0 application now supports assigning users to workflow stages during the workflow creation and editing process.

### Key Features

- **User Assignment by Email**: Users can be assigned to workflow stages by email addresses
- **Existing Users Recognition**: If an email belongs to an existing user, they are automatically assigned
- **User Invitation**: If an email doesn't match an existing user, an invitation is created
- **Role-Based Access**: Each workflow stage has an associated role (editor, admin, etc.)
- **Multiple Assignees**: Each workflow stage can have multiple assignees

### Technical Implementation

#### Database Schema

The workflow schema uses a JSONB column to store steps with assignees:

```json
{
  "steps": [
    {
      "id": 1,
      "name": "Draft Review",
      "description": "Initial review by the content author",
      "role": "editor",
      "approvalRequired": true,
      "assignees": [
        {"email": "user1@example.com", "id": "user-uuid-if-exists"},
        {"email": "user2@example.com", "id": "user-uuid-if-exists"}
      ]
    }
  ]
}
```

A separate `workflow_invitations` table tracks invitations for users not yet in the system:

```sql
CREATE TABLE workflow_invitations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  workflow_id UUID REFERENCES workflows(id) ON DELETE CASCADE,
  step_id INTEGER NOT NULL,
  email TEXT NOT NULL,
  role TEXT NOT NULL,
  invite_token TEXT NOT NULL UNIQUE,
  status TEXT DEFAULT 'pending', -- 'pending', 'accepted', 'declined'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  UNIQUE(workflow_id, step_id, email)
);
```

#### User Interface

The workflow creation and editing pages include:

- Input field for entering assignee emails
- List of current assignees with removal option
- Email validation to ensure correct format
- Prevention of duplicate email assignments

#### API Implementation

The API handles:
1. Checking if an assignee email belongs to an existing user
2. Creating invitations for new users
3. Tracking assignee status in the workflow steps
4. Managing invitation lifecycle (pending, accepted, declined)

### Usage

1. Create or edit a workflow
2. Add steps as needed
3. For each step, enter email addresses to assign users
4. Save the workflow
5. Users will either:
   - See their assignments directly (if already in the system)
   - Receive an invitation email (if not yet a user)

### Future Enhancements

- Email notification system integration
- User invitation acceptance flow
- Assignment history tracking
- Reassignment capabilities 

## Workflow Management Enhancements

The workflow management in MixerAI 2.0 has been enhanced with several usability improvements:

### Key Features

#### Improved Role Selection
- **Role Checkboxes with Descriptions**: Replaced dropdown menu with visual checkbox cards
- **Role Context**: Each role now displays a description of its responsibilities
- **Visual Clarity**: Selected roles are highlighted with a border and background color

#### Step Reordering
- **Up/Down Controls**: Added buttons to move steps up or down in the workflow
- **Step Numbering**: Clear visual indicators of step order with numbered badges
- **Drag Handles**: Intuitive controls for adjusting workflow sequence

#### Optional Steps
- **Clearer Terminology**: Changed "Require approval" to "Optional step" for better clarity
- **Enhanced Description**: Added explanation of what optional steps mean in the workflow
- **Toggle Interface**: Simple checkbox toggle with descriptive label

#### Assignee Management
- **Improved Styling**: Assignee emails now use badges for better visibility
- **Easier Removal**: One-click removal of assignees from workflow steps
- **Simplified Addition**: Enter key support for quickly adding multiple assignees

#### Auto-generate Description
- **Brand Context Awareness**: Descriptions now consider brand language and geography
- **Improved Error Handling**: Better feedback when description generation fails
- **Optimized State Updates**: Prevents UI refreshes that could cause user position loss

### Technical Improvements

#### Azure OpenAI Integration
- **Fixed Client Configuration**: Proper endpoint construction for Azure OpenAI
- **Error Handling**: Detailed error information for troubleshooting
- **API Versioning**: Updated to use the latest API version for better compatibility

#### User Interface Enhancements
- **Consistent Styling**: Harmonized UI elements across new and edit workflow pages
- **Improved Layout**: Better spacing and visual hierarchy for workflow steps
- **Responsive Design**: Layout adjustments for different screen sizes

### Usage

1. Create or edit a workflow
2. Use the step reordering buttons to arrange workflow steps in the desired sequence
3. Select the appropriate role for each step using the descriptive checkbox cards
4. Toggle "Optional step" for steps that can be skipped in certain cases
5. Use the "Auto-generate" button to quickly create professional step descriptions
6. Add assignees by email to each step in the workflow
7. Remove assignees with a single click if needed

The enhanced workflow management provides a more intuitive, user-friendly interface that makes creating and managing complex content workflows simpler and more efficient. 

## Azure OpenAI Integration Fixes

The workflow description auto-generation feature has been enhanced with improved Azure OpenAI integration:

### Key Improvements

- **Simplified API Configuration**: Removed complex client setup in favor of direct fetch calls to Azure OpenAI
- **Comprehensive Error Handling**: Added detailed error handling with informative error messages
- **Diagnostic Tools**: Created testing endpoints and scripts to validate Azure OpenAI configuration
- **Troubleshooting Guide**: Added detailed documentation for common Azure OpenAI issues

### Implementation Changes

1. **Azure OpenAI Client Configuration**:
   - Updated the Azure OpenAI client to use the correct API endpoint format
   - Fixed authentication header setup
   - Added environment variable validation

2. **Frontend Error Handling**:
   - Added pre-flight checks to verify Azure OpenAI configuration
   - Improved error message display
   - Added detailed logging for troubleshooting

3. **Testing and Diagnostics**:
   - Created `/api/test-azure-openai` endpoint for quick configuration testing
   - Added `scripts/test-azure-openai.js` for command-line testing
   - Enhanced error reporting with specific troubleshooting steps

### Technical Considerations

When using the Azure OpenAI API, these points are critical:

1. The endpoint URL format must be: `https://your-resource-name.openai.azure.com`
2. Authentication requires the `api-key` header (not `Authorization`)
3. API calls need to specify the deployment name in the URL path
4. The API version (`2023-05-15`) must be included as a query parameter

For detailed troubleshooting information, refer to the [Azure OpenAI Troubleshooting Guide](docs/AZURE_OPENAI_TROUBLESHOOTING.md). 

## Recent Fixes

### Auto-Generate Description Fix

We resolved an issue where generated descriptions from Azure OpenAI weren't being displayed in the workflow editor. The issue was related to browser extensions interfering with React's state updates. We implemented a multi-layered approach to ensure the description is updated even when state updates fail:

1. Direct DOM manipulation as a fallback
2. Multiple React state update approaches
3. Synthetic event dispatching to ensure change detection

For more details, see [Auto-Generate Description Fix](docs/AUTO_GENERATE_DESCRIPTION_FIX.md).

### Azure OpenAI Integration Improvements

We strengthened the Azure OpenAI integration with better error checking and TypeScript typing in the test endpoint. The test endpoint now provides more detailed diagnostic information when checking the Azure OpenAI configuration.

For troubleshooting Azure OpenAI issues, refer to [Azure OpenAI Troubleshooting Guide](docs/AZURE_OPENAI_TROUBLESHOOTING.md). 

## Testing and Debugging Tools

### OpenAI Testing Tools

MixerAI 2.0 includes a dedicated page for testing and debugging the Azure OpenAI integration at `/openai-test`. This page provides various tools to help developers:

- Test brand identity generation
- Test content generation
- Test Azure OpenAI connectivity
- View environment configuration
- Detect whether content is truly AI-generated or uses fallback templates

These tools are essential for diagnosing issues with AI content generation and verifying that Azure OpenAI is properly configured and working. For detailed information on using these tools, see [OPENAI_TESTING_TOOLS.md](docs/OPENAI_TESTING_TOOLS.md).

Key features:
- AI versus template detection through heuristic analysis
- Timing information for performance monitoring
- Raw API response inspection
- Direct API testing for any endpoint
- Environment configuration display 