---
description: 
globs: 
alwaysApply: true
---
# MixerAI 2.0 API Structure

This rule documents the API structure and data flow for the MixerAI 2.0 application.

## API Routes

The application uses Next.js API routes to handle server-side logic:

### Data Endpoints

- [src/app/api/brands/route.ts](mdc:mixerai-2.0/src/app/api/brands/route.ts) - Manages brand data
  - `GET`: Retrieves all brands with content count
  
- [src/app/api/content-types/route.ts](mdc:mixerai-2.0/src/app/api/content-types/route.ts) - Manages content type data
  - `GET`: Retrieves all content types
  
- [src/app/api/content/route.ts](mdc:mixerai-2.0/src/app/api/content/route.ts) - Manages content data
  - `GET`: Retrieves all content with related details (brand, content type, creator)

### Authentication Endpoints

The application uses Supabase for authentication, but may have custom authentication-related endpoints.

## Data Models

The application uses the following data models:

### Brands
```sql
CREATE TABLE brands (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  website_url TEXT,
  country TEXT,
  language TEXT,
  brand_identity TEXT,
  tone_of_voice TEXT,
  guardrails TEXT,
  content_vetting_agencies TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Content Types
```sql
CREATE TABLE content_types (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(name)
);
```

### Content
```sql
CREATE TYPE content_status AS ENUM ('draft', 'pending_review', 'approved', 'published', 'rejected');

CREATE TABLE content (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  brand_id UUID REFERENCES brands(id) ON DELETE CASCADE,
  content_type_id UUID REFERENCES content_types(id) ON DELETE CASCADE,
  workflow_id UUID REFERENCES workflows(id) ON DELETE SET NULL,
  created_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  meta_title TEXT,
  meta_description TEXT,
  status content_status NOT NULL DEFAULT 'draft',
  current_step INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Front-end Data Fetching

Front-end components fetch data from the API routes:

### Brands Page
```typescript
async function fetchBrands() {
  const response = await fetch('/api/brands');
  const data = await response.json();
  return data.success ? data.brands : [];
}
```

### Content Page
```typescript
const fetchContent = async () => {
  const response = await fetch('/api/content');
  const data = await response.json();
  return data.success ? data.content : [];
};
```

## Error Handling

API routes use standard HTTP status codes and return consistent response objects:

```typescript
// Success response
return NextResponse.json({ 
  success: true, 
  data: result.rows 
});

// Error response
return NextResponse.json(
  { success: false, error: 'Error message' },
  { status: 500 }
);
```

## Error Handling and Fallback Strategies

### Brand Identity Generation

The brand identity generation feature relies on Azure OpenAI. When AI generation fails, the application follows these principles:

1. **Fallback Generation**:
   - In `src/lib/azure/openai.ts`, the `generateBrandIdentityFromUrls` function should fall back to template-based content when OpenAI API calls fail
   - The `generateFallbackBrandIdentity` function provides industry-specific templates using URL-based detection

2. **Default Data Provision**:
   - API route (`src/app/api/brands/identity/route.ts`) always ensures complete data is returned
   - Even in error cases, default values should be provided for all required fields:
     - Brand identity
     - Tone of voice
     - Content guardrails
     - Suggested agencies
     - Brand color

3. **UI Handling**:
   - In brand edit pages (`src/app/brands/[id]/edit/page.tsx` and `src/app/brands/new/page.tsx`), the `executeGenerateBrandIdentity` function should display a toast notification but continue with fallback data
   - Set `usedFallback` state to true to inform users that default content is being used

This approach ensures users always have usable content, even when API services are unavailable.
